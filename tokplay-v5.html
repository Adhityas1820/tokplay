<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="TokPlay">
<title>TokPlay</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,500;9..40,700&family=Outfit:wght@400;600;800&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{--bg:#0a0a0c;--surface:#141418;--surface2:#1c1c22;--surface3:#24242c;--accent:#fe2c55;--accent2:#25f4ee;--accent-glow:rgba(254,44,85,.25);--text:#f0f0f2;--text2:#8e8e9a;--text3:#55555f;--safe-top:env(safe-area-inset-top,20px);--safe-bottom:env(safe-area-inset-bottom,20px)}
html,body{height:100%;width:100%;overflow:hidden;font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);-webkit-user-select:none;user-select:none}
#app{height:100%;display:flex;flex-direction:column;padding-top:var(--safe-top);padding-bottom:var(--safe-bottom);position:relative;overflow:hidden}
.ambient{position:fixed;top:-40%;left:-20%;width:140%;height:80%;background:radial-gradient(ellipse at 50% 80%,var(--accent-glow) 0%,transparent 60%);pointer-events:none;z-index:0;opacity:0;transition:opacity 1.2s ease}.ambient.playing{opacity:1}
.header{display:flex;align-items:center;justify-content:space-between;padding:12px 20px 8px;position:relative;z-index:10;flex-shrink:0}
.logo{font-family:'Outfit',sans-serif;font-weight:800;font-size:22px;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:-.5px}
.header-actions{display:flex;gap:8px}
.icon-btn{width:40px;height:40px;border-radius:12px;background:var(--surface);border:1px solid var(--surface3);display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--text2);transition:all .2s}.icon-btn:active{transform:scale(.92)}.icon-btn svg{width:20px;height:20px}
.action-bar{display:flex;gap:8px;padding:0 20px 10px;position:relative;z-index:10;flex-shrink:0}
.action-btn{flex:1;display:flex;align-items:center;justify-content:center;gap:8px;padding:14px 12px;border-radius:14px;border:none;font-family:inherit;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s}.action-btn:active{transform:scale(.97)}.action-btn.primary{background:linear-gradient(135deg,var(--accent),#ff4470);color:white}.action-btn.secondary{background:var(--surface);border:1px solid var(--surface3);color:var(--text2)}.action-btn svg{width:18px;height:18px;flex-shrink:0}
.pl-tabs-wrap{flex-shrink:0;position:relative;z-index:10;padding:0 0 8px}.pl-tabs{display:flex;gap:8px;padding:0 20px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;align-items:center}.pl-tabs::-webkit-scrollbar{display:none}
.pl-tab{flex-shrink:0;padding:8px 16px;border-radius:20px;background:var(--surface);border:1px solid var(--surface3);font-family:inherit;font-size:12px;font-weight:600;color:var(--text2);cursor:pointer;transition:all .2s;white-space:nowrap;display:flex;align-items:center;gap:6px}.pl-tab:active{transform:scale(.95)}.pl-tab.active{background:var(--accent);border-color:var(--accent);color:white}.pl-tab .cnt{font-size:10px;opacity:.7}
.pl-add{flex-shrink:0;width:32px;height:32px;border-radius:50%;background:var(--surface);border:1px solid var(--surface3);display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--accent);font-size:18px;font-weight:700;transition:all .2s}.pl-add:active{transform:scale(.9)}
.toast{position:fixed;top:calc(var(--safe-top) + 60px);left:50%;transform:translateX(-50%) translateY(-20px);background:var(--surface2);border:1px solid var(--surface3);color:var(--text);font-size:13px;font-weight:500;padding:10px 20px;border-radius:12px;z-index:300;opacity:0;transition:all .3s ease;pointer-events:none;white-space:nowrap;max-width:90vw;text-overflow:ellipsis;overflow:hidden}.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}.toast.ok{border-color:rgba(37,244,238,.3)}.toast.err{border-color:rgba(254,44,85,.3)}
.proc{display:none;position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.85);backdrop-filter:blur(8px);flex-direction:column;align-items:center;justify-content:center;gap:16px}.proc.show{display:flex}.spin{width:44px;height:44px;border:3px solid var(--surface3);border-top-color:var(--accent);border-radius:50%;animation:sp .8s linear infinite}@keyframes sp{to{transform:rotate(360deg)}}.proc-t{font-size:15px;font-weight:600;color:var(--text)}
.pl-sec{flex:1;overflow:hidden;display:flex;flex-direction:column;position:relative;z-index:10}
.pl-hdr{display:flex;align-items:center;justify-content:space-between;padding:0 20px 8px;flex-shrink:0}.pl-tr{display:flex;align-items:center;gap:8px}
.pl-name{font-family:'Outfit',sans-serif;font-weight:600;font-size:16px;color:var(--text2)}
.pl-eb{background:none;border:none;color:var(--text3);cursor:pointer;padding:4px;display:flex}.pl-eb svg{width:14px;height:14px}.pl-eb:active{color:var(--accent)}
.tc{font-size:12px;color:var(--text3);background:var(--surface);padding:4px 10px;border-radius:20px}
.clr-btn{font-size:12px;color:var(--accent);background:none;border:none;cursor:pointer;padding:4px 10px;font-family:inherit}
.tl{flex:1;overflow-y:auto;padding:0 20px 12px;-webkit-overflow-scrolling:touch}.tl::-webkit-scrollbar{display:none}
.ti{display:flex;align-items:center;gap:12px;padding:12px 14px;margin-bottom:8px;background:var(--surface);border-radius:14px;border:1px solid transparent;transition:all .25s;cursor:pointer;animation:fu .3s ease both}
@keyframes fu{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
.ti.act{border-color:var(--accent);background:linear-gradient(135deg,rgba(254,44,85,.08),rgba(37,244,238,.04));box-shadow:0 4px 24px rgba(254,44,85,.12)}.ti:active{transform:scale(.98)}
.tn{width:28px;height:28px;border-radius:8px;background:var(--surface2);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:600;color:var(--text3);flex-shrink:0}.ti.act .tn{background:var(--accent);color:white}
.tinfo{flex:1;min-width:0}.tname{font-size:14px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.tname-in{background:none;border:none;color:var(--text);font-size:14px;font-weight:500;font-family:inherit;width:100%;outline:none;padding:0}.tdur{font-size:11px;color:var(--text3);margin-top:2px}
.ta{display:flex;gap:4px;flex-shrink:0}.tb{width:32px;height:32px;border-radius:8px;background:var(--surface2);border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--text3);transition:all .2s}.tb:active{transform:scale(.88)}.tb.del:active{color:var(--accent)}.tb svg{width:14px;height:14px}
.trim-b{display:inline-block;font-size:9px;color:var(--accent2);background:rgba(37,244,238,.1);padding:1px 6px;border-radius:4px;margin-left:4px;vertical-align:middle}
.es{text-align:center;padding:40px 20px;color:var(--text3)}.es svg{width:48px;height:48px;margin-bottom:12px;opacity:.4}.es p{font-size:14px;line-height:1.5}.es .ht{font-size:11px;margin-top:8px;opacity:.7}
.np{flex-shrink:0;position:relative;z-index:10;padding:0 20px 8px}
.pc{background:var(--surface);border-radius:20px;border:1px solid var(--surface3);padding:16px 18px 14px;box-shadow:0 -8px 40px rgba(0,0,0,.4)}
.pr{display:flex;align-items:center;gap:8px;margin-bottom:12px}.pt{font-size:10px;color:var(--text3);min-width:32px;font-variant-numeric:tabular-nums}
.pb{flex:1;height:4px;background:var(--surface3);border-radius:2px;cursor:pointer;position:relative;overflow:hidden}.pf{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:2px;width:0%;transition:width .3s linear}
.ni{display:flex;align-items:center;gap:12px;margin-bottom:14px}
.na{width:44px;height:44px;border-radius:12px;flex-shrink:0;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}.na svg{width:20px;height:20px;color:white}.na .disc{position:absolute;inset:0;border:3px solid rgba(255,255,255,.15);border-radius:12px}.na.spinning .disc{animation:sp 3s linear infinite}
.nm{flex:1;min-width:0}.ntt{font-size:14px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.nst{font-size:11px;color:var(--text3);margin-top:1px}
.ctrls{display:flex;align-items:center;justify-content:center;gap:12px}.cb{width:44px;height:44px;border-radius:50%;background:var(--surface2);border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--text);transition:all .2s}.cb:active{transform:scale(.88)}.cb svg{width:20px;height:20px}.cb.play{width:56px;height:56px;background:linear-gradient(135deg,var(--accent),#ff4470);box-shadow:0 4px 20px var(--accent-glow)}.cb.play svg{width:24px;height:24px;color:white}
.cb.sm{width:38px;height:38px;font-size:11px;font-weight:700;font-family:'Outfit',sans-serif}.cb.sm.on{background:var(--accent);color:white}.cb.sm svg{width:16px;height:16px}
.sl{font-size:11px;font-weight:700;color:var(--text)}.cb.sm.on .sl{color:white}
.mo{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:100;display:none;align-items:flex-end;justify-content:center;backdrop-filter:blur(4px)}.mo.show{display:flex}
.md{width:100%;max-width:420px;background:var(--surface);border-radius:24px 24px 0 0;padding:20px 20px calc(20px + var(--safe-bottom));max-height:80vh;overflow-y:auto}
.mh{width:36px;height:4px;background:var(--surface3);border-radius:2px;margin:0 auto 16px}.md h3{font-family:'Outfit',sans-serif;font-size:18px;margin-bottom:16px}
.mb{width:100%;padding:14px;border-radius:14px;border:none;font-family:inherit;font-size:15px;font-weight:600;cursor:pointer;margin-bottom:8px;transition:all .2s}.mb:active{transform:scale(.97)}.mb.dng{background:rgba(254,44,85,.15);color:var(--accent)}.mb.can{background:var(--surface2);color:var(--text2)}.mb.pri{background:var(--accent);color:white}
.mi{width:100%;padding:14px;border-radius:14px;border:1px solid var(--surface3);background:var(--surface2);color:var(--text);font-family:inherit;font-size:15px;outline:none;margin-bottom:12px}.mi:focus{border-color:var(--accent)}
.ppl{max-height:240px;overflow-y:auto;margin-bottom:12px}
.ppi{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;margin-bottom:6px;border-radius:12px;background:var(--surface2);cursor:pointer;transition:all .2s}.ppi:active{transform:scale(.98)}
.ppn{font-size:14px;font-weight:500}.ppc{width:24px;height:24px;border-radius:50%;border:2px solid var(--surface3);display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0}
.ppi.inp .ppc{background:var(--accent);border-color:var(--accent)}.ppi.inp .ppc::after{content:'âœ“';color:white;font-size:12px;font-weight:700}
.hs{margin-bottom:20px}.hs h4{font-family:'Outfit',sans-serif;font-size:14px;font-weight:600;color:var(--accent);margin-bottom:8px;display:flex;align-items:center;gap:8px}.hs h4 .sn{width:22px;height:22px;border-radius:50%;background:var(--accent);color:white;display:flex;align-items:center;justify-content:center;font-size:11px;flex-shrink:0}.hs p{font-size:13px;color:var(--text2);line-height:1.6;padding-left:30px}.hd{height:1px;background:var(--surface3);margin:16px 0}.htip{font-size:12px;color:var(--accent2);background:rgba(37,244,238,.08);padding:10px 14px;border-radius:10px;line-height:1.5}
#fi,#li{display:none}
</style>
</head>
<body>
<div id="app">
<div class="ambient" id="amb"></div>
<div class="header"><div class="logo">TokPlay</div><div class="header-actions">
<div class="icon-btn" onclick="showHelp()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></div>
<div class="icon-btn" onclick="dlAll()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></div>
</div></div>
<div class="action-bar">
<button class="action-btn primary" onclick="document.getElementById('fi').click()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>Upload TikToks</button>
<button class="action-btn secondary" onclick="document.getElementById('li').click()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>Load Library</button>
</div>
<input type="file" id="fi" accept="video/*" multiple>
<input type="file" id="li" accept=".wav,.mp3,.m4a,.ogg,.aac,audio/*" multiple>
<div class="pl-tabs-wrap"><div class="pl-tabs" id="tabs"></div></div>
<div class="pl-sec">
<div class="pl-hdr"><div class="pl-tr"><div class="pl-name" id="pln">All Tracks</div><button class="pl-eb" id="pleb" onclick="showPlOpts()" style="display:none"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg></button></div><span class="tc" id="tc">0</span><button class="clr-btn" onclick="showClr()">Clear</button></div>
<div class="tl" id="tl"></div>
</div>
<div class="np"><div class="pc">
<div class="pr"><span class="pt" id="ct">0:00</span><div class="pb" id="pb"><div class="pf" id="pf"></div></div><span class="pt" id="tt">0:00</span></div>
<div class="ni">
<div class="na" id="nart"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3" fill="none" stroke="currentColor" stroke-width="2"/><circle cx="18" cy="16" r="3" fill="none" stroke="currentColor" stroke-width="2"/></svg><div class="disc"></div></div>
<div class="nm"><div class="ntt" id="ntt">No track selected</div><div class="nst" id="nst">Upload videos to begin</div></div>
</div>
<div class="ctrls">
<button class="cb sm" id="shB" onclick="togSh()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="16 3 21 3 21 8"/><line x1="4" y1="20" x2="21" y2="3"/><polyline points="21 16 21 21 16 21"/><line x1="15" y1="15" x2="21" y2="21"/><line x1="4" y1="4" x2="9" y2="9"/></svg></button>
<button class="cb" onclick="prev()"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 20L9 12l10-8v16z"/><rect x="5" y="4" width="2" height="16"/></svg></button>
<button class="cb play" onclick="togP()"><svg viewBox="0 0 24 24" fill="currentColor" id="pIco"><polygon points="6,3 20,12 6,21"/></svg></button>
<button class="cb" onclick="next()"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M5 4l10 8-10 8V4z"/><rect x="17" y="4" width="2" height="16"/></svg></button>
<button class="cb sm" id="spB" onclick="cycSp()"><span class="sl" id="spL">1x</span></button>
</div>
</div></div>
<div class="mo" id="clrM" onclick="if(event.target===this)this.classList.remove('show')"><div class="md"><div class="mh"></div><h3 id="clrT">Clear?</h3><p id="clrD" style="color:var(--text2);font-size:14px;margin-bottom:20px"></p><button class="mb dng" id="clrB" onclick="exClr()">Clear</button><button class="mb can" onclick="$('clrM').classList.remove('show')">Cancel</button></div></div>
<div class="mo" id="apM" onclick="if(event.target===this)this.classList.remove('show')"><div class="md"><div class="mh"></div><h3>Add to Playlist</h3><div class="ppl" id="ppl"></div><button class="mb can" onclick="$('apM').classList.remove('show')">Done</button></div></div>
<div class="mo" id="npM" onclick="if(event.target===this)this.classList.remove('show')"><div class="md"><div class="mh"></div><h3 id="npT">New Playlist</h3><input class="mi" id="npI" placeholder="Playlist name" maxlength="40"><button class="mb pri" id="npB" onclick="saveNP()">Create</button><button class="mb can" onclick="$('npM').classList.remove('show')">Cancel</button></div></div>
<div class="mo" id="poM" onclick="if(event.target===this)this.classList.remove('show')"><div class="md"><div class="mh"></div><h3 id="poT">Playlist</h3><button class="mb can" onclick="renPl()">Rename</button><button class="mb dng" onclick="delPl()">Delete Playlist</button><button class="mb can" onclick="$('poM').classList.remove('show')">Cancel</button></div></div>
<div class="mo" id="hlpM" onclick="if(event.target===this)this.classList.remove('show')"><div class="md"><div class="mh"></div><h3>How to Use TokPlay</h3>
<div class="hs"><h4><span class="sn">1</span> Save TikToks</h4><p>In TikTok, tap share â†’ "Save video" to Photos.</p></div>
<div class="hs"><h4><span class="sn">2</span> Upload</h4><p>Tap <strong>Upload TikToks</strong> â†’ select from Photos. Audio extracted, last 5s trimmed.</p></div>
<div class="hs"><h4><span class="sn">3</span> Playlists</h4><p>Tap <strong>+</strong> to create playlists. Use the âŠž button on any track to add it. Tracks can be in multiple playlists.</p></div>
<div class="hs"><h4><span class="sn">4</span> Play</h4><p>Tap any track. Use shuffle, speed (1x/1.5x/2x/0.5x). Works with screen locked.</p></div>
<div class="hd"></div>
<div class="hs"><h4><span class="sn">ðŸ’¾</span> Backups</h4><p>Tap â†“ on tracks or header. Saves as <strong>TokPlay_name.wav</strong>. Use <strong>Load Library</strong> to reload.</p></div>
<div class="htip"><strong>ðŸ’¡ Tip:</strong> Create a "TokPlay" folder in Files. Move downloads there. Load Library â†’ open folder â†’ Select All â†’ Done.</div>
<button class="mb can" onclick="$('hlpM').classList.remove('show')" style="margin-top:16px">Got it!</button>
</div></div>
<div class="proc" id="proc"><div class="spin"></div><div class="proc-t" id="prT">Preparing...</div></div>
<div class="toast" id="tst"></div>
</div>
<script>
const $=id=>document.getElementById(id);
let AT=[],PL=[],aPl='__all__',pPl='__all__',cI=-1,playing=false,shuf=false,spd=1;
const SPDS=[1,1.5,2,0.5],aud=new Audio(),TRIM=5,DBN='TokPlayDB3';
function odb(){return new Promise((y,n)=>{const r=indexedDB.open(DBN,1);r.onupgradeneeded=e=>{const d=e.target.result;if(!d.objectStoreNames.contains('t'))d.createObjectStore('t',{keyPath:'id'});if(!d.objectStoreNames.contains('m'))d.createObjectStore('m',{keyPath:'k'})};r.onsuccess=()=>y(r.result);r.onerror=()=>n(r.error)})}
async function dST(t){const d=await odb();return new Promise((y,n)=>{const x=d.transaction('t','readwrite');x.objectStore('t').put({id:t.id,name:t.name,blob:t.blob,fd:t.fd,dur:t.dur,lib:!!t.lib});x.oncomplete=y;x.onerror=()=>n(x.error)})}
async function dDT(id){const d=await odb();return new Promise((y,n)=>{const x=d.transaction('t','readwrite');x.objectStore('t').delete(id);x.oncomplete=y;x.onerror=()=>n(x.error)})}
async function dCT(){const d=await odb();return new Promise((y,n)=>{const x=d.transaction('t','readwrite');x.objectStore('t').clear();x.oncomplete=y;x.onerror=()=>n(x.error)})}
async function dLT(){const d=await odb();return new Promise((y,n)=>{const x=d.transaction('t','readonly');const r=x.objectStore('t').getAll();r.onsuccess=()=>y(r.result);r.onerror=()=>n(r.error)})}
async function dSM(){const d=await odb();return new Promise((y,n)=>{const x=d.transaction('m','readwrite');x.objectStore('m').put({k:'s',pls:PL,apl:aPl,ppl:pPl,ci:cI,sh:shuf,sp:spd,ord:AT.map(t=>t.id)});x.oncomplete=y;x.onerror=()=>n(x.error)})}
async function dLM(){const d=await odb();return new Promise((y,n)=>{const x=d.transaction('m','readonly');const r=x.objectStore('m').get('s');r.onsuccess=()=>y(r.result||null);r.onerror=()=>n(r.error)})}
function uid(){return crypto.randomUUID?crypto.randomUUID():Date.now().toString(36)+Math.random().toString(36).slice(2)}
function gDur(u){return new Promise(r=>{const a=new Audio();a.preload='metadata';a.src=u;a.onloadedmetadata=()=>r(a.duration);a.onerror=()=>r(0);setTimeout(()=>r(0),3000)})}
function vis(){if(aPl==='__all__')return AT;const p=PL.find(x=>x.id===aPl);return p?p.tids.map(id=>AT.find(t=>t.id===id)).filter(Boolean):AT}
function pQ(){if(pPl==='__all__')return AT;const p=PL.find(x=>x.id===pPl);return p?p.tids.map(id=>AT.find(t=>t.id===id)).filter(Boolean):AT}
let tT;function tst(m,t='ok'){const e=$('tst');e.textContent=m;e.className='toast show '+t;clearTimeout(tT);tT=setTimeout(()=>e.className='toast',2500)}
function esc(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}
function fmt(s){if(!s||isNaN(s))return'0:00';return`${Math.floor(s/60)}:${String(Math.floor(s%60)).padStart(2,'0')}`}
function sP(m){$('proc').classList.add('show');$('prT').textContent=m}
function hP(){$('proc').classList.remove('show')}

$('fi').onchange=async e=>{const f=Array.from(e.target.files);if(!f.length)return;let n=0;
for(const fi of f){const nm=fi.name.replace(/\.[^.]+$/,'').replace(/[-_]/g,' '),id=uid(),u=URL.createObjectURL(fi),fd=await gDur(u),dur=Math.max(fd-TRIM,1);
const t={id,name:nm,blob:fi,url:u,fd,dur};AT.push(t);await dST(t);n++}
rAll();if(cI===-1&&AT.length){pPl=aPl;ldT(0,false)}dSM();tst(`Added ${n} track${n>1?'s':''}`);e.target.value=''};

$('li').onchange=async e=>{const f=Array.from(e.target.files);if(!f.length)return;let n=0;
for(const fi of f){const nm=fi.name.replace(/\.[^.]+$/,'').replace(/^TokPlay_/,'').replace(/[-_]/g,' '),id=uid(),u=URL.createObjectURL(fi),dur=await gDur(u);
const t={id,name:nm,blob:fi,url:u,fd:dur,dur,lib:true};AT.push(t);await dST(t);n++}
rAll();if(cI===-1&&AT.length){pPl=aPl;ldT(0,false)}dSM();tst(`Loaded ${n}`);e.target.value=''};

function rAll(){rTabs();rTrks()}
function rTabs(){const c=$('tabs');let h=`<div class="pl-tab ${aPl==='__all__'?'active':''}" onclick="swPl('__all__')">All Tracks <span class="cnt">${AT.length}</span></div>`;
for(const p of PL){const c2=p.tids.filter(id=>AT.find(t=>t.id===id)).length;h+=`<div class="pl-tab ${aPl===p.id?'active':''}" onclick="swPl('${p.id}')">${esc(p.name)} <span class="cnt">${c2}</span></div>`}
h+=`<div class="pl-add" onclick="showNP()">+</div>`;c.innerHTML=h;
$('pleb').style.display=aPl==='__all__'?'none':'flex';
const pl=PL.find(p=>p.id===aPl);$('pln').textContent=aPl==='__all__'?'All Tracks':pl?pl.name:'All Tracks'}

function rTrks(){const l=$('tl'),v=vis(),q=pQ();$('tc').textContent=v.length+' track'+(v.length!==1?'s':'');
if(!v.length){l.innerHTML=`<div class="es"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><path d="M9 12l2 2 4-4"/></svg><p>${aPl==='__all__'?'Upload TikTok videos to get started':'This playlist is empty'}</p><p class="ht">${aPl==='__all__'?'Tap <strong>?</strong> for help':'Use âŠž on tracks to add them'}</p></div>`;return}
l.innerHTML=v.map((t,i)=>{const act=pPl===aPl&&q[cI]?.id===t.id;
return`<div class="ti${act?' act':''}" onclick="pVis(${i})" style="animation-delay:${i*.03}s"><div class="tn">${act?'â–¶':i+1}</div><div class="tinfo"><div class="tname" id="n${i}">${esc(t.name)}${t.lib?'':'<span class="trim-b">-'+TRIM+'s</span>'}</div><div class="tdur">${fmt(t.dur)}</div></div><div class="ta"><button class="tb" onclick="showAP('${t.id}',event)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg></button><button class="tb" onclick="edNm('${t.id}',${i},event)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button><button class="tb" onclick="dl1('${t.id}',event)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></button><button class="tb del" onclick="delT('${t.id}',event)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/></svg></button></div></div>`}).join('')}
*2,ab=new ArrayBuffer(44+dl),v=new DataView(ab),w=(o,s)=>{for(let i=0;i<s.length;i++)v.setUint8(o+i,s.charCodeAt(i))};w(0,'RIFF');v.setUint32(4,36+dl,true);w(8,'WAVE');w(12,'fmt ');v.setUint32(16,16,true);v.setUint16(20,1,true);v.setUint16(22,ch,true);v.setUint32(24,sr,true);v.setUint32(28,sr*ch*2,true);v.setUint16(32,ch*2,true);v.setUint16(34,16,true);w(36,'data');v.setUint32(40,dl,true);let o=44;for(let i=0;i<inter.length;i++){let s=Math.max(-1,Math.min(1,inter[i]));v.setInt16(o,s<0?s*0x8000:s*0x7FFF,true);o+=2}return new Blob([ab],{type:'audio/wav'})}
function dlB(b,n){const u=URL.createObjectURL(b),a=document.createElement('a');a.href=u;a.download=n;document.body.appendChild(a);a.click();document.body.removeChild(a);setTimeout(()=>URL.revokeObjectURL(u),5000)}
function san(n){return n.replace(/[^a-zA-Z0-9_\- ]/g,'').replace(/\s+/g,'_').substring(0,60)}
async function dl1(tid,e){e.stopPropagation();const t=AT.find(x=>x.id===tid);if(!t)return;sP('Preparing...');try{const w=await tEnc(t);dlB(w,'TokPlay_'+san(t.name)+'.wav');tst('Saved')}catch(er){dlB(t.blob,'TokPlay_'+san(t.name)+'.original');tst('Saved original','err')}hP()}
async function dlAll(){const v=vis();if(!v.length){tst('No tracks','err');return}sP('Preparing...');for(let i=0;i<v.length;i++){$('prT').textContent=`Encoding ${i+1}/${v.length}...`;try{const w=await tEnc(v[i]);dlB(w,'TokPlay_'+san(v[i].name)+'.wav')}catch(er){dlB(v[i].blob,'TokPlay_'+san(v[i].name)+'.original')}await new Promise(r=>setTimeout(r,500))}hP();tst(v.length+' files saved')}
function showHelp(){$('hlpM').classList.add('show')}
if('mediaSession'in navigator){navigator.mediaSession.setActionHandler('play',()=>togP());navigator.mediaSession.setActionHandler('pause',()=>togP());navigator.mediaSession.setActionHandler('previoustrack',()=>prev());navigator.mediaSession.setActionHandler('nexttrack',()=>next());navigator.mediaSession.setActionHandler('seekto',d=>{if(d.seekTime!=null)aud.currentTime=d.seekTime})}

(async()=>{try{
const[td,meta]=await Promise.all([dLT(),dLM()]);
if(meta){PL=meta.pls||[];aPl=meta.apl||'__all__';pPl=meta.ppl||'__all__';cI=meta.ci??-1;
if(meta.sh){shuf=true;$('shB').classList.add('on')}
if(meta.sp&&SPDS.includes(meta.sp)){spd=meta.sp;aud.playbackRate=spd;$('spL').textContent=spd+'x';if(spd!==1)$('spB').classList.add('on')}
const ord=meta.ord||[];
for(const id of ord){const it=td.find(x=>x.id===id);if(it?.blob){const u=URL.createObjectURL(it.blob);AT.push({id:it.id,name:it.name,blob:it.blob,url:u,fd:it.fd||it.dur,dur:it.dur,lib:!!it.lib})}}
for(const it of td){if(!AT.find(x=>x.id===it.id)&&it.blob){const u=URL.createObjectURL(it.blob);AT.push({id:it.id,name:it.name,blob:it.blob,url:u,fd:it.fd||it.dur,dur:it.dur,lib:!!it.lib})}}}
else{for(const it of td){if(it.blob){const u=URL.createObjectURL(it.blob);AT.push({id:it.id,name:it.name,blob:it.blob,url:u,fd:it.fd||it.dur,dur:it.dur,lib:!!it.lib})}}if(AT.length)cI=0}
const q=pQ();if(cI>=q.length)cI=q.length?0:-1;
rAll();if(cI>=0)ldT(cI,false);
}catch(e){console.warn('Init:',e);rAll()}})();
</script>
</body></html>
