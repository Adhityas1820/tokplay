<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="TokPlay">
<title>TokPlay - TikTok Audio Player</title>
<link rel="manifest" href="data:application/json,{}">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,500;0,9..40,700;1,9..40,400&family=Outfit:wght@400;600;800&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{
  --bg:#0a0a0c;
  --surface:#141418;
  --surface2:#1c1c22;
  --surface3:#24242c;
  --accent:#fe2c55;
  --accent2:#25f4ee;
  --accent-glow:rgba(254,44,85,.25);
  --text:#f0f0f2;
  --text2:#8e8e9a;
  --text3:#55555f;
  --radius:16px;
  --safe-top:env(safe-area-inset-top,20px);
  --safe-bottom:env(safe-area-inset-bottom,20px);
}
html,body{
  height:100%;width:100%;overflow:hidden;
  font-family:'DM Sans',sans-serif;
  background:var(--bg);color:var(--text);
  -webkit-user-select:none;user-select:none;
}
#app{
  height:100%;display:flex;flex-direction:column;
  padding-top:var(--safe-top);
  padding-bottom:var(--safe-bottom);
  position:relative;overflow:hidden;
}

/* Ambient glow */
.ambient{
  position:fixed;top:-40%;left:-20%;width:140%;height:80%;
  background:radial-gradient(ellipse at 50% 80%,var(--accent-glow) 0%,transparent 60%);
  pointer-events:none;z-index:0;
  opacity:0;transition:opacity 1.2s ease;
}
.ambient.playing{opacity:1}

/* Header */
.header{
  display:flex;align-items:center;justify-content:space-between;
  padding:12px 20px 8px;position:relative;z-index:10;
  flex-shrink:0;
}
.logo{
  font-family:'Outfit',sans-serif;font-weight:800;font-size:22px;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  letter-spacing:-0.5px;
}
.header-actions{display:flex;gap:8px}
.icon-btn{
  width:40px;height:40px;border-radius:12px;
  background:var(--surface);border:1px solid var(--surface3);
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;color:var(--text2);transition:all .2s;
}
.icon-btn:active{transform:scale(.92);background:var(--surface2)}
.icon-btn svg{width:20px;height:20px}

/* Upload zone */
.upload-zone{
  margin:8px 20px 12px;padding:28px 20px;
  border:2px dashed var(--surface3);border-radius:var(--radius);
  text-align:center;cursor:pointer;transition:all .3s;
  position:relative;z-index:10;flex-shrink:0;
}
.upload-zone:active{border-color:var(--accent);background:rgba(254,44,85,.05)}
.upload-zone svg{width:36px;height:36px;color:var(--accent);margin-bottom:8px}
.upload-title{font-weight:600;font-size:15px;margin-bottom:2px}
.upload-sub{font-size:12px;color:var(--text2)}

/* Playlist area */
.playlist-section{
  flex:1;overflow:hidden;display:flex;flex-direction:column;
  position:relative;z-index:10;
}
.playlist-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:8px 20px;flex-shrink:0;
}
.playlist-title{font-family:'Outfit',sans-serif;font-weight:600;font-size:16px;color:var(--text2)}
.track-count{
  font-size:12px;color:var(--text3);
  background:var(--surface);padding:4px 10px;border-radius:20px;
}
.clear-btn{
  font-size:12px;color:var(--accent);background:none;border:none;
  cursor:pointer;padding:4px 10px;font-family:inherit;
}

.tracks-list{
  flex:1;overflow-y:auto;padding:0 20px 12px;
  -webkit-overflow-scrolling:touch;
}
.tracks-list::-webkit-scrollbar{display:none}

.track-item{
  display:flex;align-items:center;gap:12px;
  padding:12px 14px;margin-bottom:8px;
  background:var(--surface);border-radius:14px;
  border:1px solid transparent;
  transition:all .25s;cursor:pointer;position:relative;
}
.track-item.active{
  border-color:var(--accent);
  background:linear-gradient(135deg,rgba(254,44,85,.08),rgba(37,244,238,.04));
  box-shadow:0 4px 24px rgba(254,44,85,.12);
}
.track-item:active{transform:scale(.98)}

.track-num{
  width:28px;height:28px;border-radius:8px;
  background:var(--surface2);
  display:flex;align-items:center;justify-content:center;
  font-size:12px;font-weight:600;color:var(--text3);flex-shrink:0;
}
.track-item.active .track-num{
  background:var(--accent);color:white;
}
.track-info{flex:1;min-width:0}
.track-name{
  font-size:14px;font-weight:500;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}
.track-name-input{
  background:none;border:none;color:var(--text);
  font-size:14px;font-weight:500;font-family:inherit;
  width:100%;outline:none;padding:0;
}
.track-duration{font-size:11px;color:var(--text3);margin-top:2px}
.track-actions{display:flex;gap:4px;flex-shrink:0}
.track-btn{
  width:32px;height:32px;border-radius:8px;background:var(--surface2);
  border:none;display:flex;align-items:center;justify-content:center;
  cursor:pointer;color:var(--text3);transition:all .2s;
}
.track-btn:active{transform:scale(.88)}
.track-btn.delete:active{color:var(--accent)}
.track-btn svg{width:14px;height:14px}

.empty-state{
  text-align:center;padding:48px 20px;color:var(--text3);
}
.empty-state svg{width:48px;height:48px;margin-bottom:12px;opacity:.4}
.empty-state p{font-size:14px}

/* Now Playing Bar */
.now-playing{
  flex-shrink:0;position:relative;z-index:10;
  padding:0 20px 8px;
}
.player-card{
  background:var(--surface);border-radius:20px;
  border:1px solid var(--surface3);
  padding:16px 18px 14px;
  backdrop-filter:blur(20px);
  box-shadow:0 -8px 40px rgba(0,0,0,.4);
}

.progress-row{display:flex;align-items:center;gap:8px;margin-bottom:12px}
.progress-time{font-size:10px;color:var(--text3);min-width:32px;font-variant-numeric:tabular-nums}
.progress-bar{
  flex:1;height:4px;background:var(--surface3);border-radius:2px;
  cursor:pointer;position:relative;overflow:hidden;
}
.progress-fill{
  height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));
  border-radius:2px;width:0%;transition:width .3s linear;
}

.now-info{
  display:flex;align-items:center;gap:12px;margin-bottom:14px;
}
.now-art{
  width:44px;height:44px;border-radius:12px;flex-shrink:0;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  display:flex;align-items:center;justify-content:center;
  position:relative;overflow:hidden;
}
.now-art svg{width:20px;height:20px;color:white}
.now-art .disc{
  position:absolute;inset:0;
  border:3px solid rgba(255,255,255,.15);border-radius:12px;
}
.now-art.spinning .disc{
  animation:spin 3s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}
.now-meta{flex:1;min-width:0}
.now-title{
  font-size:14px;font-weight:600;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}
.now-status{font-size:11px;color:var(--text3);margin-top:1px}

.controls{display:flex;align-items:center;justify-content:center;gap:16px}
.ctrl-btn{
  width:44px;height:44px;border-radius:50%;
  background:var(--surface2);border:none;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;color:var(--text);transition:all .2s;
}
.ctrl-btn:active{transform:scale(.88)}
.ctrl-btn svg{width:20px;height:20px}
.ctrl-btn.play{
  width:56px;height:56px;
  background:linear-gradient(135deg,var(--accent),#ff4470);
  box-shadow:0 4px 20px var(--accent-glow);
}
.ctrl-btn.play svg{width:24px;height:24px;color:white}

/* Modal */
.modal-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.6);
  z-index:100;display:none;align-items:flex-end;justify-content:center;
  backdrop-filter:blur(4px);
}
.modal-overlay.show{display:flex}
.modal{
  width:100%;max-width:420px;
  background:var(--surface);border-radius:24px 24px 0 0;
  padding:20px 20px calc(20px + var(--safe-bottom));
  max-height:70vh;
}
.modal-handle{
  width:36px;height:4px;background:var(--surface3);
  border-radius:2px;margin:0 auto 16px;
}
.modal h3{font-family:'Outfit',sans-serif;font-size:18px;margin-bottom:16px}
.modal-btn{
  width:100%;padding:14px;border-radius:14px;border:none;
  font-family:inherit;font-size:15px;font-weight:600;
  cursor:pointer;margin-bottom:8px;transition:all .2s;
}
.modal-btn:active{transform:scale(.97)}
.modal-btn.danger{background:rgba(254,44,85,.15);color:var(--accent)}
.modal-btn.cancel{background:var(--surface2);color:var(--text2)}

/* Scrollbar */
::-webkit-scrollbar{width:0}

/* Hidden file input */
#fileInput{display:none}

/* Animations */
@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
.track-item{animation:fadeUp .3s ease both}
</style>
</head>
<body>
<div id="app">
  <div class="ambient" id="ambient"></div>

  <div class="header">
    <div class="logo">TokPlay</div>
    <div class="header-actions">
      <div class="icon-btn" onclick="document.getElementById('fileInput').click()" title="Add tracks">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      </div>
    </div>
  </div>

  <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
    <div class="upload-title">Upload TikTok Videos</div>
    <div class="upload-sub">Tap to select .mp4 files — audio will be extracted</div>
  </div>

  <input type="file" id="fileInput" accept="video/*,.mp4,.mov,.webm" multiple>

  <div class="playlist-section">
    <div class="playlist-header">
      <div class="playlist-title">Playlist</div>
      <span class="track-count" id="trackCount">0 tracks</span>
      <button class="clear-btn" id="clearBtn" onclick="showClearModal()">Clear All</button>
    </div>
    <div class="tracks-list" id="tracksList">
      <div class="empty-state" id="emptyState">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><path d="M9 12l2 2 4-4"/></svg>
        <p>Upload TikTok videos to start your playlist</p>
      </div>
    </div>
  </div>

  <div class="now-playing">
    <div class="player-card">
      <div class="progress-row">
        <span class="progress-time" id="currentTime">0:00</span>
        <div class="progress-bar" id="progressBar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <span class="progress-time" id="totalTime">0:00</span>
      </div>
      <div class="now-info">
        <div class="now-art" id="nowArt">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3" fill="none" stroke="currentColor" stroke-width="2"/><circle cx="18" cy="16" r="3" fill="none" stroke="currentColor" stroke-width="2"/></svg>
          <div class="disc"></div>
        </div>
        <div class="now-meta">
          <div class="now-title" id="nowTitle">No track selected</div>
          <div class="now-status" id="nowStatus">Upload videos to begin</div>
        </div>
      </div>
      <div class="controls">
        <button class="ctrl-btn" onclick="prevTrack()">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 20L9 12l10-8v16z"/><rect x="5" y="4" width="2" height="16"/></svg>
        </button>
        <button class="ctrl-btn play" id="playBtn" onclick="togglePlay()">
          <svg viewBox="0 0 24 24" fill="currentColor" id="playIcon"><polygon points="6,3 20,12 6,21"/></svg>
        </button>
        <button class="ctrl-btn" onclick="nextTrack()">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M5 4l10 8-10 8V4z"/><rect x="17" y="4" width="2" height="16"/></svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Clear modal -->
  <div class="modal-overlay" id="clearModal">
    <div class="modal">
      <div class="modal-handle"></div>
      <h3>Clear Playlist?</h3>
      <p style="color:var(--text2);font-size:14px;margin-bottom:20px">This will remove all tracks. This can't be undone.</p>
      <button class="modal-btn danger" onclick="clearPlaylist()">Clear All Tracks</button>
      <button class="modal-btn cancel" onclick="hideClearModal()">Cancel</button>
    </div>
  </div>
</div>

<script>
// ─── State ───
let tracks = [];
let currentIndex = -1;
let isPlaying = false;
const audio = new Audio();

// ─── Persistence ───
const STORAGE_KEY = 'tokplay_tracks';
const INDEX_KEY = 'tokplay_index';

function saveTracks() {
  try {
    const data = tracks.map(t => ({
      name: t.name,
      blob: null, // can't store blobs in localStorage
      dataUrl: t.dataUrl || null,
    }));
    // For persistence we use dataURLs (works for reasonable file sizes)
    const toSave = [];
    let pending = tracks.length;
    if (pending === 0) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify([]));
      localStorage.setItem(INDEX_KEY, String(currentIndex));
      return;
    }
    tracks.forEach((t, i) => {
      if (t.dataUrl) {
        toSave[i] = { name: t.name, dataUrl: t.dataUrl };
        pending--;
        if (pending === 0) {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(toSave));
          localStorage.setItem(INDEX_KEY, String(currentIndex));
        }
      } else {
        const reader = new FileReader();
        reader.onload = () => {
          t.dataUrl = reader.result;
          toSave[i] = { name: t.name, dataUrl: t.dataUrl };
          pending--;
          if (pending === 0) {
            try {
              localStorage.setItem(STORAGE_KEY, JSON.stringify(toSave));
              localStorage.setItem(INDEX_KEY, String(currentIndex));
            } catch(e) {
              // Storage quota exceeded - try indexedDB fallback
              saveToIDB(toSave);
            }
          }
        };
        reader.readAsDataURL(t.blob);
      }
    });
  } catch(e) { console.warn('Save error', e); }
}

function loadTracks() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    const data = JSON.parse(raw);
    data.forEach(item => {
      if (item && item.dataUrl) {
        tracks.push({
          name: item.name,
          dataUrl: item.dataUrl,
          blob: null,
          url: item.dataUrl,
          duration: 0,
        });
      }
    });
    const savedIdx = parseInt(localStorage.getItem(INDEX_KEY) || '-1');
    if (savedIdx >= 0 && savedIdx < tracks.length) currentIndex = savedIdx;
    renderTracks();
    if (currentIndex >= 0) loadTrack(currentIndex, false);
  } catch(e) { console.warn('Load error', e); }
}

// IndexedDB fallback for large playlists
function saveToIDB(data) {
  const req = indexedDB.open('tokplay', 1);
  req.onupgradeneeded = e => {
    e.target.result.createObjectStore('tracks');
  };
  req.onsuccess = e => {
    const db = e.target.result;
    const tx = db.transaction('tracks', 'readwrite');
    tx.objectStore('tracks').put(data, 'playlist');
    tx.objectStore('tracks').put(currentIndex, 'index');
  };
}

// ─── File Upload ───
document.getElementById('fileInput').addEventListener('change', e => {
  const files = Array.from(e.target.files);
  files.forEach(file => {
    const url = URL.createObjectURL(file);
    const tempAudio = new Audio();
    tempAudio.src = url;
    const trackName = file.name.replace(/\.[^.]+$/, '').replace(/[-_]/g, ' ');
    const track = {
      name: trackName,
      blob: file,
      dataUrl: null,
      url: url,
      duration: 0,
    };
    tempAudio.addEventListener('loadedmetadata', () => {
      track.duration = tempAudio.duration;
      renderTracks();
    });
    tracks.push(track);
  });
  renderTracks();
  if (currentIndex === -1 && tracks.length > 0) {
    loadTrack(0, false);
  }
  saveTracks();
  e.target.value = '';
});

// ─── Render ───
function renderTracks() {
  const list = document.getElementById('tracksList');
  const empty = document.getElementById('emptyState');
  document.getElementById('trackCount').textContent = `${tracks.length} track${tracks.length !== 1 ? 's' : ''}`;

  if (tracks.length === 0) {
    list.innerHTML = '';
    list.appendChild(createEmptyState());
    return;
  }

  list.innerHTML = tracks.map((t, i) => `
    <div class="track-item ${i === currentIndex ? 'active' : ''}" onclick="loadTrack(${i}, true)" style="animation-delay:${i * .04}s">
      <div class="track-num">${i === currentIndex ? '▶' : i + 1}</div>
      <div class="track-info">
        <div class="track-name" id="tn-${i}" ondblclick="editName(${i}, event)">${escHtml(t.name)}</div>
        <div class="track-duration">${formatTime(t.duration)}</div>
      </div>
      <div class="track-actions">
        <button class="track-btn" onclick="editName(${i}, event)" title="Rename">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
        </button>
        <button class="track-btn delete" onclick="deleteTrack(${i}, event)" title="Delete">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/></svg>
        </button>
      </div>
    </div>
  `).join('');
}

function createEmptyState() {
  const div = document.createElement('div');
  div.className = 'empty-state';
  div.id = 'emptyState';
  div.innerHTML = `
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><path d="M9 12l2 2 4-4"/></svg>
    <p>Upload TikTok videos to start your playlist</p>`;
  return div;
}

function escHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ─── Playback ───
function loadTrack(index, autoplay) {
  if (index < 0 || index >= tracks.length) return;
  currentIndex = index;
  const track = tracks[index];
  audio.src = track.url || track.dataUrl;
  audio.load();

  document.getElementById('nowTitle').textContent = track.name;
  document.getElementById('nowStatus').textContent = `Track ${index + 1} of ${tracks.length}`;
  renderTracks();
  saveTracks();

  if (autoplay) {
    audio.play().then(() => {
      isPlaying = true;
      updatePlayBtn();
    }).catch(()=>{});
  }
}

function togglePlay() {
  if (tracks.length === 0) return;
  if (currentIndex === -1) { loadTrack(0, true); return; }

  if (isPlaying) {
    audio.pause();
    isPlaying = false;
  } else {
    audio.play().then(() => { isPlaying = true; }).catch(()=>{});
  }
  updatePlayBtn();
}

function updatePlayBtn() {
  const icon = document.getElementById('playIcon');
  const art = document.getElementById('nowArt');
  const ambient = document.getElementById('ambient');
  if (isPlaying) {
    icon.innerHTML = '<rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/>';
    art.classList.add('spinning');
    ambient.classList.add('playing');
  } else {
    icon.innerHTML = '<polygon points="6,3 20,12 6,21"/>';
    art.classList.remove('spinning');
    ambient.classList.remove('playing');
  }
}

function nextTrack() {
  if (tracks.length === 0) return;
  const next = (currentIndex + 1) % tracks.length;
  loadTrack(next, true);
}

function prevTrack() {
  if (tracks.length === 0) return;
  if (audio.currentTime > 3) {
    audio.currentTime = 0;
    return;
  }
  const prev = (currentIndex - 1 + tracks.length) % tracks.length;
  loadTrack(prev, true);
}

// Auto-play next
audio.addEventListener('ended', () => {
  nextTrack();
});

audio.addEventListener('pause', () => {
  isPlaying = false;
  updatePlayBtn();
});

audio.addEventListener('play', () => {
  isPlaying = true;
  updatePlayBtn();
  // Update media session
  if ('mediaSession' in navigator && tracks[currentIndex]) {
    navigator.mediaSession.metadata = new MediaMetadata({
      title: tracks[currentIndex].name,
      artist: 'TokPlay',
      album: 'TikTok Audio',
    });
  }
});

// ─── Progress ───
audio.addEventListener('timeupdate', () => {
  if (!audio.duration) return;
  const pct = (audio.currentTime / audio.duration) * 100;
  document.getElementById('progressFill').style.width = pct + '%';
  document.getElementById('currentTime').textContent = formatTime(audio.currentTime);
  document.getElementById('totalTime').textContent = formatTime(audio.duration);
});

// Seek
document.getElementById('progressBar').addEventListener('click', e => {
  if (!audio.duration) return;
  const rect = e.currentTarget.getBoundingClientRect();
  const pct = (e.clientX - rect.left) / rect.width;
  audio.currentTime = pct * audio.duration;
});

// ─── Track Management ───
function editName(index, event) {
  event.stopPropagation();
  const el = document.getElementById(`tn-${index}`);
  const current = tracks[index].name;
  el.innerHTML = `<input class="track-name-input" value="${escHtml(current)}" 
    onblur="saveName(${index}, this)" 
    onkeydown="if(event.key==='Enter')this.blur()" 
    autofocus>`;
  const input = el.querySelector('input');
  input.focus();
  input.select();
}

function saveName(index, input) {
  const val = input.value.trim() || tracks[index].name;
  tracks[index].name = val;
  if (index === currentIndex) {
    document.getElementById('nowTitle').textContent = val;
  }
  renderTracks();
  saveTracks();
}

function deleteTrack(index, event) {
  event.stopPropagation();
  const wasPlaying = isPlaying && index === currentIndex;
  if (index === currentIndex) {
    audio.pause();
    isPlaying = false;
  }

  // Revoke object URL
  if (tracks[index].url && tracks[index].url.startsWith('blob:')) {
    URL.revokeObjectURL(tracks[index].url);
  }
  tracks.splice(index, 1);

  if (tracks.length === 0) {
    currentIndex = -1;
    document.getElementById('nowTitle').textContent = 'No track selected';
    document.getElementById('nowStatus').textContent = 'Upload videos to begin';
    document.getElementById('progressFill').style.width = '0%';
    updatePlayBtn();
  } else if (index === currentIndex) {
    currentIndex = Math.min(index, tracks.length - 1);
    loadTrack(currentIndex, wasPlaying);
  } else if (index < currentIndex) {
    currentIndex--;
  }

  renderTracks();
  saveTracks();
}

function showClearModal() {
  if (tracks.length === 0) return;
  document.getElementById('clearModal').classList.add('show');
}
function hideClearModal() {
  document.getElementById('clearModal').classList.remove('show');
}

function clearPlaylist() {
  audio.pause();
  audio.src = '';
  isPlaying = false;
  tracks.forEach(t => {
    if (t.url && t.url.startsWith('blob:')) URL.revokeObjectURL(t.url);
  });
  tracks = [];
  currentIndex = -1;
  document.getElementById('nowTitle').textContent = 'No track selected';
  document.getElementById('nowStatus').textContent = 'Upload videos to begin';
  document.getElementById('progressFill').style.width = '0%';
  document.getElementById('currentTime').textContent = '0:00';
  document.getElementById('totalTime').textContent = '0:00';
  updatePlayBtn();
  renderTracks();
  saveTracks();
  hideClearModal();
}

// ─── Media Session (lock screen controls) ───
if ('mediaSession' in navigator) {
  navigator.mediaSession.setActionHandler('play', () => togglePlay());
  navigator.mediaSession.setActionHandler('pause', () => togglePlay());
  navigator.mediaSession.setActionHandler('previoustrack', () => prevTrack());
  navigator.mediaSession.setActionHandler('nexttrack', () => nextTrack());
  navigator.mediaSession.setActionHandler('seekto', (d) => {
    if (d.seekTime != null) audio.currentTime = d.seekTime;
  });
}

// ─── Utility ───
function formatTime(s) {
  if (!s || isNaN(s)) return '0:00';
  const m = Math.floor(s / 60);
  const sec = Math.floor(s % 60);
  return `${m}:${sec.toString().padStart(2, '0')}`;
}

// Close modal on overlay click
document.getElementById('clearModal').addEventListener('click', e => {
  if (e.target === e.currentTarget) hideClearModal();
});

// ─── Init ───
loadTracks();
</script>
</body>
</html>
